{% extends 'base.html' %}
{% block content %}
<h1>Border0 Organization Configuration</h1>
<p class="text-muted">Use this page to configure your Border0 organization and client token. First, set your organization name, then login to Border0 to retrieve your client token, and finally upload the token to enable device connectivity.</p>

<!-- Organization setup and device service status -->
<div class="row mb-4">
    <div class="card h-100">
      <div class="card-body">
        {% if not org %}
        <form method="post" class="row g-3">
          <div class="col-md-8">
            <label for="org" class="form-label">Organization Name</label>
            <input type="text" class="form-control" id="org" name="org" value="{{ org }}" required maxlength="30"
                   placeholder="e.g., my-org-name"
                   title="Enter your Border0 organization name">            
          </div>
          <div class="col-md-4 align-self-end">
            <button type="submit" name="action" value="save_org" class="btn btn-primary"
                    title="Save organization name for login and token retrieval">Save Organization</button>
          </div>
        </form>
        {% else %}
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <label class="form-label mb-0">Organization:</label>
            <div><strong>{{ org }}</strong></div>
          </div>
          <div>
            <form method="post" class="d-inline">
              <button type="submit" name="action" value="reset_org" class="btn btn-secondary me-2"
                      title="Reset saved organization, client token, and device state; stop VPN service">Reset Org Settings</button>
            </form>
            {% if not token_exists %}
            <form method="post" class="d-inline">
              <button type="submit" name="action" value="login" class="btn btn-primary"
                      title="Login to Border0 to obtain a new client token for your organization">Login to Border0</button>
            </form>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% if login_url %}
  <div class="alert alert-info">
    <script>window.open('{{ login_url }}', '_blank');</script>
    <p>A new window has been opened for Border0 authentication.<br>
    If it didnâ€™t open automatically, <a href="{{ login_url }}" target="_blank">click here</a> to proceed.</p>
    <p>Once authentication is complete, reload this page to continue.</p>
    <p>Auto-refreshing in <span id="b0-countdown">60</span> seconds...</p>
    <script>
      (function(){
        var seconds = 60;
        var countdownEl = document.getElementById('b0-countdown');
        if (countdownEl) {
          var interval = setInterval(function() {
            seconds--;
            countdownEl.textContent = seconds;
            if (seconds <= 0) {
              clearInterval(interval);
              location.reload();
            }
          }, 1000);
        }
      })();
    </script>
  </div>
{% endif %}

<!-- Token upload and VPN installation -->
{% if org and not token_exists %}
  <div class="card mb-4">
    <div class="card-body">
      <p>No Border0 client token found. Please paste your client token below:</p>
      <form method="post">
        <div class="mb-3">
          <label for="token" class="form-label">Client Token</label>
          <textarea class="form-control" id="token" name="token" rows="5" required
                    placeholder="Paste the client token provided by Border0"
                    title="Client token obtained after authentication"></textarea>
        </div>
        <button type="submit" name="action" value="upload_token" class="btn btn-primary"
                title="Save the client token to enable device connectivity">Save Token</button>
      </form>
    </div>
  </div>
{% endif %}
{% if org %}
<div class="row mb-4">
  <div class="card h-100">
    <div class="card-header"><strong>Border0 Device Service Status</strong></div>
    <div class="card-body">
      <div class="mb-3">
        <span class="fw-bold {{ 'text-success' if service_enabled else 'text-danger' }}">{{ 'Enabled' if service_enabled else 'Disabled' }}</span>&nbsp;/&nbsp;<span class="fw-bold {{ 'text-success' if service_active else 'text-danger' }}">{{ 'Active' if service_active else 'Inactive' }}</span>
      </div>
      <pre class="small text-muted" style="white-space: pre-wrap; word-wrap: break-word;">{{ device_status }}</pre>
      <form method="post" class="mt-3">
        <button type="submit" name="action" value="install_vpn" class="btn btn-primary">Restart device service</button>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% if service_active %}
  <div class="card mb-4">
    <div class="card-body">
      <h2>Exit Node Selection</h2>
      {% if current_exit_node %}
        <p>Currently selected exit node: <strong>{{ current_exit_node }}</strong></p>
      {% else %}
        <p>No exit node selected.</p>
      {% endif %}
      {% if exitnode_error %}
        <div class="alert alert-danger">Error fetching exit nodes: {{ exitnode_error }}</div>
      {% endif %}
      <form method="post">
        <div class="mb-3">
          <label for="exit_node" class="form-label">Select Exit Node</label>
          <select class="form-select" id="exit_node" name="exit_node">
            <option value="none" {% if not current_exit_node %}selected{% endif %}>None</option>
            {% for en in exit_nodes %}
              <option value="{{ en.name }}" {% if en.name == current_exit_node %}selected{% endif %}>
                {{ en.name }} ({{ en.peer_name }}, {{ en.dns_name }})
              </option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" name="action" value="set_exitnode" class="btn btn-primary">Save Exit Node</button>
      </form>
      <div class="mt-4">
        <h3>Available Exit Nodes</h3>
        <table class="table table-striped exit-nodes-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Peer</th>
              <th>DNS Name</th>
              <th>IPs</th>
              <th>Location</th>
              <th>ISP</th>
            </tr>
          </thead>
          <tbody>
            {% for en in exit_nodes %}
            <tr>
              <td>{{ en.name }}</td>
              <td>{{ en.peer_name }}</td>
              <td>{{ en.dns_name }}</td>
              <td>
                {% for ip in en.public_ips %}{{ ip.ip_address }}<br>{% endfor %}
              </td>
              <td>
                {% for ip in en.public_ips %}{{ ip.metadata.city_name }}, {{ ip.metadata.region_name }}, {{ ip.metadata.country_name }}<br>{% endfor %}
              </td>
              <td>
                {% for ip in en.public_ips %}{{ ip.metadata.isp }}<br>{% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}
