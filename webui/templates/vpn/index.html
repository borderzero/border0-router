{% extends 'base.html' %}
{% block content %}
<h1>Border0 Organization Config</h1>

<!-- Organization setup and device service status -->
<div class="row mb-4">
  <div class="col-md-8">
    <div class="card h-100">
      <div class="card-body">
        <form method="post" class="row g-3">
          <div class="col-md-8">
            <label for="org" class="form-label">Organization Name</label>
            <input type="text" class="form-control" id="org" name="org" value="{{ org }}" required maxlength="30">
          </div>
          <div class="col-md-4 align-self-end">
            <button type="submit" name="action" value="save_org" class="btn btn-primary">Save Organization</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header"><strong>Border0 Device Service</strong> Status</div>
      <div class="card-body d-flex flex-column justify-content-center align-items-center">
        <span class="badge bg-{{ device_status_badge }} text-capitalize">{{ device_status }}</span>
        {% if org %}
        <form method="post" class="mt-3">
          <button type="submit" name="action" value="install_vpn" class="btn btn-primary">Restart device service</button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# Show current organization if already set #}
{% if org %}
  <div class="mb-4">
    <p>Current organization: <strong>{{ org }}</strong></p>
  </div>
{% endif %}

<!-- Initiate login and service management -->
{% if org %}
  {% if login_url %}
    <div class="alert alert-info">
      <script>window.open('{{ login_url }}', '_blank');</script>
      <p>A new window has been opened for Border0 authentication.<br>
      If it didnâ€™t open automatically, <a href="{{ login_url }}" target="_blank">click here</a> to proceed.</p>
      <p>Once authentication is complete, reload this page to continue.</p>
    </div>
  {% endif %}
  <div class="mb-4">
    <form method="post" class="d-flex gap-2">
      <button type="submit" name="action" value="login" class="btn btn-primary">Login to border0</button>
    </form>
  </div>
{% endif %}

<!-- Token upload and VPN installation -->
{%- if not org %}
  <div class="card mb-4">
    <div class="card-body">
      <p>No Border0 client token found. Please Configure the Organization above or paste your client token below:</p>
      <form method="post">
        <div class="mb-3">
          <label for="token" class="form-label">Client Token</label>
          <textarea class="form-control" id="token" name="token" rows="5" required></textarea>
        </div>
        <button type="submit" name="action" value="upload_token" class="btn btn-primary">Save Token</button>
      </form>
    </div>
  </div>
{%- endif %}
{% if service_active %}
  <div class="card mb-4">
    <div class="card-body">
      <h2>Exit Node Selection</h2>
      {% if current_exit_node %}
        <p>Currently selected exit node: <strong>{{ current_exit_node }}</strong></p>
      {% else %}
        <p>No exit node selected.</p>
      {% endif %}
      {% if exitnode_error %}
        <div class="alert alert-danger">Error fetching exit nodes: {{ exitnode_error }}</div>
      {% endif %}
      <form method="post">
        <div class="mb-3">
          <label for="exit_node" class="form-label">Select Exit Node</label>
          <select class="form-select" id="exit_node" name="exit_node">
            <option value="none" {% if not current_exit_node %}selected{% endif %}>None</option>
            {% for en in exit_nodes %}
              <option value="{{ en.name }}" {% if en.name == current_exit_node %}selected{% endif %}>
                {{ en.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" name="action" value="set_exitnode" class="btn btn-primary">Save Exit Node</button>
      </form>
      <div class="mt-4">
        <h3>Available Exit Nodes</h3>
        <table class="table table-striped exit-nodes-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Peer</th>
              <th>DNS Name</th>
              <th>IPs</th>
              <th>Location</th>
              <th>ISP</th>
            </tr>
          </thead>
          <tbody>
            {% for en in exit_nodes %}
            <tr>
              <td>{{ en.name }}</td>
              <td>{{ en.peer_name }}</td>
              <td>{{ en.dns_name }}</td>
              <td>
                {% for ip in en.public_ips %}{{ ip.ip_address }}<br>{% endfor %}
              </td>
              <td>
                {% for ip in en.public_ips %}{{ ip.metadata.city_name }}, {{ ip.metadata.region_name }}, {{ ip.metadata.country_name }}<br>{% endfor %}
              </td>
              <td>
                {% for ip in en.public_ips %}{{ ip.metadata.isp }}<br>{% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}
