<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Config Editor</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    {{template "menu.html"}}
  
  <div class="content">
    <h1>Edit Configuration</h1>
    {{if .error}}
    <div class="error-message">
      <p>{{.error}}</p>
    </div>
    {{end}}
    <form method="post" action="/config">
      <label for="ssid">WiFi Name (SSID):</label><br>
      <input type="text" id="ssid" name="ssid" value="{{.config.SSID}}"><br><br>

      <label for="psk">WiFi Password (PSK):</label><br>
      <div class="password-container">
        <input type="password" id="psk" name="psk" value="{{.config.PSK}}">
        <button type="button" id="togglePassword" class="toggle-password">Show</button>
      </div>
      <small>Password must be at least 8 characters long (default: border0123)</small><br><br>

      <div class="button-group">
        <input type="submit" value="Save Configuration" class="button">
        <button type="button" id="applyAndReboot" class="button apply-button">Apply and Reboot WiFi</button>
      </div>
    </form>
  </div>
  
  <style>
    .error-message {
      background-color: #ffdddd;
      padding: 15px;
      border-radius: 5px;
      color: #990000;
      margin-bottom: 20px;
    }
    small {
      color: #666;
    }
    .password-container {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .toggle-password {
      margin-left: 10px;
      cursor: pointer;
      padding: 5px 10px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .button-group {
      display: flex;
      gap: 15px;
    }
    .button {
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .apply-button {
      background-color: #4CAF50;
      color: white;
      border: none;
    }
    .apply-button:hover {
      background-color: #45a049;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toggleButton = document.getElementById('togglePassword');
      const passwordInput = document.getElementById('psk');
      
      toggleButton.addEventListener('click', function() {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          toggleButton.textContent = 'Hide';
        } else {
          passwordInput.type = 'password';
          toggleButton.textContent = 'Show';
        }
      });

      // Add event listener for Apply and Reboot button
      const applyButton = document.getElementById('applyAndReboot');
      applyButton.addEventListener('click', function() {
        // Get form values
        const ssid = document.getElementById('ssid').value;
        const psk = document.getElementById('psk').value;
        
        // Validate PSK length
        if (psk.length < 8) {
          alert('PSK must be at least 8 characters long');
          return;
        }
        
        // Send request to apply configuration and reboot
        fetch('/apply-config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            ssid: ssid,
            psk: psk
          })
        })
        .then(response => {
          if (response.ok) {
            alert('Configuration applied. System will reboot now.');
            // Redirect to a "rebooting" page or show a message
            window.location.href = '/';
          } else {
            alert('Failed to apply configuration. Please try again.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred. Please try again.');
        });
      });
    });
  </script>
</body>
</html>
